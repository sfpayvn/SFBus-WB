<div class="rounded-lg bg-white p-4 shadow-sm">
  <h2 class="mb-4 text-lg font-semibold text-gray-800">Đặt chỗ gần đây</h2>
  <div class="overflow-x-auto">
    <nz-table
      #rowSelectionTable
      nzShowPagination
      nzShowSizeChanger
      [nzFrontPagination]="false"
      [nzData]="bookins"
      [nzLoading]="!isLoaded"
      class="!w-full">
      <thead>
        <tr>
          <th class="min-w-[30px]"></th>
          <th class="min-w-[60px]">#</th>
          <th class="min-w-[150px]">Tên</th>
          <th class="min-w-[40px]">Sđt</th>
          <th class="min-w-[80px]">SL Vé</th>
          <th class="min-w-[80px]">Tổng Tiền</th>
          <th class="min-w-[80px]">Status</th>
          <th class="min-w-[80px]">Thời gian đặt</th>
          <th class="min-w-[80px] !text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (booking of rowSelectionTable.data; track booking) {
        <tr [class.bg-gray-50]="isExpanded(booking._id)">
          <td class="!py-2">
            <button
              (click)="toggleExpand(booking._id)"
              class="hover:text-primary text-gray-600 transition-all duration-200"
              [attr.aria-expanded]="isExpanded(booking._id)">
              <svg-icon
                [src]="
                  isExpanded(booking._id)
                    ? 'assets/icons/heroicons/outline/chevron-down.svg'
                    : 'assets/icons/heroicons/outline/chevron-right.svg'
                "
                [svgClass]="'h-6 w-6'"></svg-icon>
            </button>
          </td>
          <td>
            <nz-skeleton [nzLoading]="!isLoaded" [nzParagraph]="false" [nzTitle]="{ width: '100%' }" [nzActive]="true">
              {{ booking.bookingNumber }}
            </nz-skeleton>
          </td>
          <td>
            <nz-skeleton [nzLoading]="!isLoaded" [nzParagraph]="false" [nzTitle]="{ width: '100%' }" [nzActive]="true">
              {{ booking.userInfo.name }}
            </nz-skeleton>
          </td>
          <td>
            <nz-skeleton [nzLoading]="!isLoaded" [nzParagraph]="false" [nzTitle]="{ width: '100%' }" [nzActive]="true">
              {{ booking.userInfo.phoneNumber }}
            </nz-skeleton>
          </td>

          <td>
            <nz-skeleton [nzLoading]="!isLoaded" [nzParagraph]="false" [nzTitle]="{ width: '100%' }" [nzActive]="true">
              {{ booking.bookingItems.length }}
            </nz-skeleton>
          </td>
          <td>
            <nz-skeleton [nzLoading]="!isLoaded" [nzParagraph]="false" [nzTitle]="{ width: '100%' }" [nzActive]="true">
              {{ utils.formatPriceToVND(booking.afterDiscountTotalPrice) }}
            </nz-skeleton>
          </td>
          <td>
            <nz-skeleton [nzLoading]="!isLoaded" [nzParagraph]="false" [nzTitle]="{ width: '100%' }" [nzActive]="true">
              <span class="p-2 uppercase rounded-md text-xs {{ getBookingStatusClass(booking.status) }}">
                {{ bookingStatuses[booking.status] }}
              </span>
            </nz-skeleton>
          </td>
          <td>
            <nz-skeleton [nzLoading]="!isLoaded" [nzParagraph]="false" [nzTitle]="{ width: '100%' }" [nzActive]="true">
              {{ booking.createdAt | date: 'short' }}
            </nz-skeleton>
          </td>
          <td class="text-right">
            <nz-skeleton [nzLoading]="!isLoaded" [nzParagraph]="false" [nzTitle]="{ width: '100%' }" [nzActive]="true">
              <button
                (click)="viewDetailBooking(booking)"
                class="text-muted-foreground hover:bg-card hover:text-foreground inline-flex h-7 w-7 cursor-pointer items-center justify-center rounded-md"
                aria-label="Edit user">
                <svg viewBox="0 0 20 20" fill="currentColor" class="size-5">
                  <path
                    d="m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.886L17.5 5.501a2.121 2.121 0 0 0-3-3L3.58 13.419a4 4 0 0 0-.885 1.343Z" />
                </svg>
              </button>
            </nz-skeleton>
          </td>
        </tr>
        <!-- Expandable Row with booking items -->
        <tr>
          <td colspan="9" class="!border-0 !p-0">
            <nz-collapse [nzBordered]="false" [nzGhost]="true">
              <nz-collapse-panel [nzActive]="isExpanded(booking._id)" [nzShowArrow]="false" [nzDisabled]="true">
                <div class="flex flex-col gap-2">
                  <label class="text-sm font-semibold text-gray-700">Thông tin ghế:</label>
                  @if (booking.bookingItems && booking.bookingItems.length > 0) {
                  <div class="grid gap-3">
                    @for (bookingItem of booking.bookingItems; let i = $index; track $index ) {
                    <div class="rounded-lg border border-blue-200 bg-blue-50 p-3">
                      <div class="mb-2 flex items-center justify-between gap-2">
                        <div class="flex gap-2">
                          <span class="rounded bg-blue-500 px-2 py-1 text-xs font-semibold text-white">
                            {{ getTypeOfSeat(bookingItem.seat)?.name }} {{ bookingItem.seat.name }}
                          </span>
                          <span
                            class="{{
                              getSeatStatusClass(bookingItem.seat.status)
                            }} px-2 py-1 rounded text-xs font-semibold border">
                            {{ getSeatStatusLabel(bookingItem.seat.status) || 'Chưa xác định' }}
                          </span>
                        </div>
                      </div>
                      <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                          <label class="font-medium text-gray-600">Điểm đón:</label>
                          <span class="ml-2 text-gray-700">{{ bookingItem.departure || 'Chưa có thông tin' }}</span>
                        </div>
                        <div>
                          <label class="font-medium text-gray-600">Điểm trả:</label>
                          <span class="ml-2 text-gray-700">{{ bookingItem.destination || 'Chưa có thông tin' }}</span>
                        </div>
                        <div>
                          <label class="font-medium text-gray-600">Giá ghế:</label>
                          <span class="ml-2 text-gray-700">{{ utils.formatPriceToVND(bookingItem.price || 0) }}</span>
                        </div>
                        <div>
                          <label class="font-medium text-gray-600">Loại ghế:</label>
                          <span class="ml-2 text-gray-700">{{ getTypeOfSeat(bookingItem.seat)?.name }}</span>
                        </div>
                      </div>
                    </div>
                    }
                  </div>
                  } @else {
                  <span class="text-sm text-gray-500">Chưa có thông tin ghế</span>
                  }
                </div>
              </nz-collapse-panel>
            </nz-collapse>
          </td>
        </tr>
        }
      </tbody>
    </nz-table>
  </div>
</div>
