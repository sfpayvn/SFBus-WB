<div class="mb-4 flex justify-end" *ngIf="!isDialog">
  <div class="inline-block space-x-4">
    <button
      class="bg-muted text-muted-foreground hover:text-foreground rounded-md px-4 py-2.5 text-xs font-semibold"
      (click)="backPage()">
      Back
    </button>
  </div>
</div>

<div class="flex w-full flex-col gap-4">
  <div class="border-muted/20 bg-background flex min-w-full flex-col rounded-xl border p-6">
    <div class="flex w-full gap-4">
      <label class="mb-4 flex text-2xl font-semibold">
        {{ isEditMode ? 'Edit Notification Schedule' : 'Create New Notification Schedule' }}
      </label>
      @if(this.schedule){
      <span class="text-2xl font-semibold">#{{ this.schedule.scheduleNumber }}</span>
      }
    </div>
    <!-- Form Content -->
    <form [formGroup]="form" nz-form class="space-y-6 px-6 py-6">
      <!-- Title Section -->
      <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
        <nz-form-item class="!min-h-[96px] !w-full">
          <nz-form-label nzFor="title" [nzNoColon]="true" [nzRequired]="true" class="!flex !items-center !justify-start"
            >Title</nz-form-label
          >
          <nz-form-control [nzErrorTip]="titleErrorTpl" class="!flex flex-col">
            <nz-input-group
              [nzSuffix]="titleClearTpl"
              class="custom-nz-input-group !mt-0 !mb-0 !rounded border-gray-200">
              <input type="text" nz-input formControlName="title" placeholder="Notification title" />
            </nz-input-group>
            <ng-template #titleClearTpl>
              <span
                nz-icon
                class="ant-input-clear-icon"
                nzTheme="fill"
                nzType="close-circle"
                (click)="form.controls['title'].patchValue('')"></span>
            </ng-template>
            <ng-template #titleErrorTpl let-control>
              <span class="mt-1 !text-xs text-red-500">
                <span *ngIf="form.get('title')?.hasError('required')">Title is required</span>
                <span *ngIf="form.get('title')?.hasError('minlength')">Title must be at least 3 characters</span>
              </span>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="!w-full">
          <nz-form-label nzFor="name" [nzNoColon]="true" [nzRequired]="true" class="!flex !items-center !justify-start"
            >Name</nz-form-label
          >
          <nz-form-control [nzErrorTip]="busScheduleDetailNameErrorTpl" class="!flex flex-col">
            <nz-input-group
              [nzSuffix]="busScheduleDetailNameClearTpl"
              class="custom-nz-input-group !mt-0 !mb-0 !rounded border-gray-200">
              <input type="text" nz-input formControlName="title" placeholder="Nháº­p Name" />
            </nz-input-group>
            <ng-template #busScheduleDetailNameClearTpl>
              <span nz-icon class="ant-input-clear-icon" nzTheme="fill" nzType="close-circle"></span>
            </ng-template>
            <ng-template #busScheduleDetailNameErrorTpl let-control>
              <span class="mt-1 !text-xs text-red-500"> </span>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="!min-h-[96px] !w-full">
          <nz-form-label
            nzFor="status"
            [nzNoColon]="true"
            [nzRequired]="true"
            class="!flex !items-center !justify-start"
            >Status</nz-form-label
          >
          <nz-form-control class="!flex flex-col">
            <nz-select id="status" formControlName="status" nzPlaceHolder="Select status" style="width: 100%">
              <nz-option *ngFor="let option of statusOptions" [nzValue]="option.value" [nzLabel]="option.label">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

      <!-- Description -->
      <nz-form-item class="!min-h-[96px] !w-full">
        <nz-form-label
          nzFor="description"
          [nzNoColon]="true"
          [nzRequired]="true"
          class="!flex !items-center !justify-start"
          >Description</nz-form-label
        >
        <nz-form-control [nzErrorTip]="descriptionErrorTpl" class="!flex flex-col">
          <nz-input-group
            [nzSuffix]="descriptionClearTpl"
            class="custom-nz-input-group !mt-0 !mb-0 !rounded border-gray-200">
            <textarea
              id="description"
              rows="2"
              formControlName="description"
              nz-input
              placeholder="Brief description of the notification"></textarea>
          </nz-input-group>
          <ng-template #descriptionClearTpl>
            <span
              nz-icon
              class="ant-input-clear-icon"
              nzTheme="fill"
              nzType="close-circle"
              (click)="form.controls['description'].patchValue('')"></span>
          </ng-template>
          <ng-template #descriptionErrorTpl let-control>
            <span class="mt-1 !text-xs text-red-500">
              <span *ngIf="form.get('description')?.hasError('required')">Description is required</span>
              <span *ngIf="form.get('description')?.hasError('minlength')"
                >Description must be at least 5 characters</span
              >
            </span>
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <!-- Content -->
      <nz-form-item class="!min-h-[96px] !w-full">
        <nz-form-label nzFor="content" [nzNoColon]="true" [nzRequired]="true" class="!flex !items-center !justify-start"
          >Content</nz-form-label
        >
        <nz-form-control [nzErrorTip]="contentErrorTpl" class="!flex flex-col">
          <nz-input-group
            [nzSuffix]="contentClearTpl"
            class="custom-nz-input-group !mt-0 !mb-0 !rounded border-gray-200">
            <textarea
              id="content"
              rows="4"
              formControlName="content"
              nz-input
              placeholder="Full notification content"></textarea>
          </nz-input-group>
          <ng-template #contentClearTpl>
            <span
              nz-icon
              class="ant-input-clear-icon"
              nzTheme="fill"
              nzType="close-circle"
              (click)="form.controls['content'].patchValue('')"></span>
          </ng-template>
          <ng-template #contentErrorTpl let-control>
            <span class="mt-1 !text-xs text-red-500">
              <span *ngIf="form.get('content')?.hasError('required')">Content is required</span>
              <span *ngIf="form.get('content')?.hasError('minlength')">Content must be at least 10 characters</span>
            </span>
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <!-- Schedule Section -->
      <div class="border-t border-gray-200 pt-6">
        <h3 class="mb-4 text-lg font-semibold text-gray-900">Schedule Details</h3>

        <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
          <nz-form-item class="!min-h-[96px] !w-full">
            <nz-form-label
              nzFor="scheduledDate"
              [nzNoColon]="true"
              [nzRequired]="true"
              class="!flex !items-center !justify-start"
              >Scheduled Date</nz-form-label
            >
            <nz-form-control class="!flex flex-col">
              <nz-date-picker
                id="scheduledDate"
                formControlName="scheduledDate"
                nzPlaceHolder="Select date"
                style="width: 100%">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="!min-h-[96px] !w-full">
            <nz-form-label
              nzFor="scheduledTime"
              [nzNoColon]="true"
              [nzRequired]="true"
              class="!flex !items-center !justify-start"
              >Time (HH:mm)</nz-form-label
            >
            <nz-form-control class="!flex flex-col">
              <nz-time-picker
                id="scheduledTime"
                formControlName="scheduledTime"
                nzPlaceHolder="Select time"
                style="width: 100%">
              </nz-time-picker>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="!min-h-[96px] !w-full">
            <nz-form-label
              nzFor="frequency"
              [nzNoColon]="true"
              [nzRequired]="true"
              class="!flex !items-center !justify-start"
              >Frequency</nz-form-label
            >
            <nz-form-control class="!flex flex-col">
              <nz-select
                id="frequency"
                formControlName="frequency"
                nzPlaceHolder="Select frequency"
                style="width: 100%">
                <nz-option *ngFor="let option of frequencyOptions" [nzValue]="option.value" [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="!min-h-[96px] !w-full">
            <nz-form-label nzFor="endDate" [nzNoColon]="true" class="!flex !items-center !justify-start"
              >End Date (for recurring)</nz-form-label
            >
            <nz-form-control class="!flex flex-col">
              <nz-date-picker id="endDate" formControlName="endDate" nzPlaceHolder="Select date" style="width: 100%">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <nz-form-item class="!mt-4 !min-h-[64px] !w-full">
          <nz-form-control class="!flex flex-col">
            <label nz-checkbox formControlName="isActive">
              <span>Active</span>
            </label>
          </nz-form-control>
        </nz-form-item>
      </div>

      <!-- Recipients Section -->
      <div class="border-t border-gray-200 pt-6">
        <h3 class="mb-4 text-lg font-semibold text-gray-900">Recipients *</h3>

        <div class="mb-4 flex gap-2">
          <nz-input-group class="!flex-1 !rounded border-gray-200">
            <input
              type="text"
              nz-input
              [(ngModel)]="newRecipientUserId"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Enter user ID" />
          </nz-input-group>
          <button type="button" nz-button nzType="primary" (click)="addRecipient()">Add</button>
        </div>

        <div class="space-y-2">
          <div
            *ngFor="let recipient of recipientList; let i = index; trackBy: trackByRecipient"
            class="flex items-center justify-between rounded-lg bg-gray-50 p-3">
            <span class="text-sm font-medium text-gray-900">{{ recipient.userId }}</span>
            <button type="button" nz-button nzType="text" nzDanger (click)="removeRecipient(i)">Remove</button>
          </div>
        </div>

        <p *ngIf="recipientList.length === 0" class="mt-3 text-sm text-gray-500">
          No recipients added yet. Add at least one recipient.
        </p>
      </div>

      <!-- Notes -->
      <nz-form-item class="!min-h-[96px] !w-full">
        <nz-form-label nzFor="notes" [nzNoColon]="true" class="!flex !items-center !justify-start">Notes</nz-form-label>
        <nz-form-control class="!flex flex-col">
          <nz-input-group
            [nzSuffix]="notesClearTpl"
            class="ant-input-affix-wrapper-textarea-with-clear-btn !mt-0 !mb-0 !rounded border-gray-200">
            <textarea
              id="notes"
              rows="2"
              formControlName="notes"
              nz-input
              placeholder="Additional notes (optional)"></textarea>
          </nz-input-group>
          <ng-template #notesClearTpl>
            <span
              nz-icon
              class="ant-input-clear-icon"
              nzTheme="fill"
              nzType="close-circle"
              (click)="form.controls['notes'].patchValue('')"></span>
          </ng-template>
        </nz-form-control>
      </nz-form-item>
    </form>

    <!-- Footer -->
    <div class="flex gap-3 space-x-4 border-t border-gray-200 px-6 py-4">
      <button
        (click)="submit()"
        [disabled]="isSubmitting || !form.valid || recipientList.length === 0"
        nz-button
        nzType="primary"
        class="!flex-initial">
        <span *ngIf="!isSubmitting">{{ isEditMode ? 'Update' : 'Create' }}</span>
        <span *ngIf="isSubmitting" class="inline-flex items-center gap-2">
          <svg class="h-4 w-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Saving...
        </span>
      </button>
      <button (click)="cancel()" nz-button nzType="default" class="!flex-initial">Cancel</button>
    </div>
  </div>
</div>
